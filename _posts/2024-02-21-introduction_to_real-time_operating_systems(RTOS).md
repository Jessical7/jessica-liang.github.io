---
layout: post
title: introduction_to_real-time_operating_systems(RTOS)
date: 2024-02-21
tags: [study_note]
author: taot
---

## 实时操作系统(RTOS)介绍

### 1 实时操作系统介绍

[实时操作系统(RTOS)](https://zh.wikipedia.org/wiki/%E5%AE%9E%E6%97%B6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F)实时操作系统(RTOS)在维基百科上的定义如下：

> **实时操作系统**（Real-time operating system, RTOS），又称即时操作系统，它会按照排序运行、管理系统资源，并为开发应用程序提供一致的基础。
> 
> 实时操作系统与一般的操作系统相比，最大的特色就是“实时性”，如果有一个任务需要执行，实时操作系统会马上（在较短时间内）执行该任务，不会有较长的延时。这种特性保证了各个任务的及时执行。

实时操作系统经常与**嵌入式操作系统**一起出现，实际上这是完全不同的两种东西。大多数实时操作系统都是嵌入式操作系统，但嵌入式操作系统并不全都是实时的。

实时操作系统(RTOS)最大的特征是**实时性**。

维基百科上关于[实时性](https://link.zhihu.com/?target=https%3A//zh.wikipedia.org/wiki/%25E5%25AE%259E%25E6%2597%25B6%25E8%25AE%25A1%25E7%25AE%2597)的定义:

> 实时运算（Real-time computing）是计算机科学中对受到“实时约束”的计算机硬件和计算机软件系统的研究，实时约束像是从事件发生到系统回应之间的最长时间限制。实时程序必须保证在严格的时间限制内响应。

实时操作系统中都要包含一个**实时任务调度器**，这个任务调度器与其它操作系统的最大不同是强调：严格按照优先级来分配CPU时间，并且时间片轮转不是实时调度器的一个必选项。

实时操作系统主要是为了解决两个问题：
* 早期的CPU任务切换的开销太大，实时调度器可以避免任务频繁切换导致CPU时间的浪费；
* 在一些特殊的应用场景中，必须要保证重要的任务优先被执行。

实时任务调度器是实时操作系统的一个必选项，但不代表只要设计出来一个实时调度器就足够了。事实上设计一个实时调度内核并不是一个多么复杂的任务，实时操作系统的特性是在整个操作系统的设计思路上都要时刻关注实时性。


### 2 实时操作系统特点

#### 2.1 实时的消息、事件处理机制

常规的操作系统中，消息队列都是按照FIFO（先进先出）的方式进行调度，如果有多个接受者，那么接受者也是按照FIFO的原则接受消息（数据），但实时操作系统会提供基于优先级的处理方式：两个任务优先级是分别是10和20，同时等待一个信号量，如果按照优先级方式处理，则优先级为10的任务会优先收到信号量。

#### 2.2 提供内核级的优先级翻转处理方式

实时操作系统调度器最经常遇到的问题就是优先级翻转，因此对于类似信号量一类的API，都能提供抑止优先级翻转的机制，防止操作系统死锁。

#### 2.3 减少粗粒度的锁和长期关中断的使用

这里的锁主要是指自旋锁(spinlock)一类会影响中断的锁，也包括任何关中断的操作。在Windows和Linux的驱动中，为了同步的需要，可能会长期关闭中断，这里的长期可能是毫秒到百微秒级。但实时操作系统通常不允许长期关中断。

对于非实时操作系统来说，如果收到一个外部中断，那么操作系统在处理中断的整个过程中可能会一直关中断。但实时操作系统的通常做法是把中断作为一个事件通告给另外一个任务，interrupt handler在处理完关键数据以后，立即打开中断，驱动的中断处理程序以一个高优先级任务的方式继续执行。

#### 2.4 系统级的服务也要保证实时性

对于一些系统级的服务，比如文件系统操作，非实时系统会缓存用户请求，并不直接把数据写入设备，或者建立一系列的线程池，分发文件系统请求。但实时系统中允许高优先级的任务优先写入数据，在文件系统提供服务的整个过程中，高优先级的请求被优先处理，这种高优先级策略直到操作完成。

这种设计实际上会牺牲性能，但实时系统强调的是整个系统层面的实时性，而不是某一个点（比如内核）的实时性，所以系统服务也要实时。

由于应用场景的差异，会出现有些用户需要实时性的驱动，有些用户需要高性能的驱动，因此实时操作系统实际上要提供多种形式的配置以满足不同实时性需求的用户。

#### 2.5 避免提供实时性不确定的API

多数实时操作系统都不支持虚拟内存（page file/swap area），主要原因是缺页中断（page fault）会导致任务调度的不确定性增加。实时操作系统很多都支持分页，但很少会使用虚拟内存，因为一次缺页中断的开销十分巨大（通常都是毫秒级），波及的代码很多，导致用户程序执行的不确定性增加。

实时操作系统的确定性是一个很重要的指标，在某些极端场景下，甚至会禁用动态内存分配（malloc/free），来保证系统不受到动态的任务变化的干扰。

#### 2.6 提供针对实时系统调度的专用API

ARINC 653标准中就针对任务调度等作出了一系列的规定，同时定义了特定的API接口和API行为.

#### 2.7 降低系统抖动

由于关中断等原因，通常情况下，操作系统的调度器不会太精确的产生周期性的调度，比如x86早期的默认60的时钟周期（clock rate），抖动范围可能在15-17ms之间。但一个设计优秀的实时操作系统能把调度器的抖动降低到微秒甚至百纳秒一级，在像x86这种天生抖动就很大的架构上，降低系统抖动尤其重要。

#### 2.8 针对实时性设计的SMP和虚拟化技术

SMP（多核）场景的实时调度是很困难的，这里还涉及到任务核间迁移的开销。针对SMP场景，多数实时操作系统的设计都不算十分优秀，但比起普通操作系统来说，其实时性已经好很多了。

同时实时操作系统的虚拟化能从hypervisor层面上提供虚拟机级别的实时调度，虚拟机上可以是另外一个实时系统，也可以是一个非实时系统。


* 非实时操作系统也可以很快，实时操作系统也可能很慢；
* 通常来说实时操作系统的吞吐量会大一些，但非实时系统也可以做到吞吐量更大；
* 实时操作系统一般都比非实时操作系统要小，但规模大的实时操作系统也是存在的。而且由于可能需要针对不同用户提供不同等级的实时服务，实时操作系统可能并不是那么精简的。


由于设备性能的发展，原来很多实时性要求高的场景，已经切换到普通的操作系统了。Linux在嵌入式设备上的推广，使用实时操作系统的很多设备已经改用Linux了，因为硬件性能的提升会让系统延迟降低到一个用户可以接受的程度。同时，由于实时操作系统的特性，它并不是一个应用场景广泛的系统，嵌入式系统和实时系统不是等完全相同的，嵌入式开发，不一定需要在实时操作系统下完成。


### 3 常见的实时操作系统

#### 3.1 $\mu CLinux$

μClinux是一种嵌入式Linux版本，其全称为micro-control Linux，从字面意思看是指微控制Linux。同标准的Linux相比，μClinux的内核非常小，但是它仍然继承了Linux操作系统的主要特性，包括良好的稳定性和移植性、强大的网络功能、出色的文件系统支持、标准丰富的API，以及TCP／IP网络协议等。因为没有MMU内存管理单元，所以其多任务的实现需要一定技巧。

μClinux在结构上继承了标准Linux的多任务实现方式，分为实时进程和普通进程，分别采用先来先服务和时间片轮转调度，仅针对中低档嵌入式CPU特点进行改良，且不支持内核抢占，实时性一般。

μClinux最大特点在于针对无MMU处理器设计。μClinux结构复杂，移植相对困难，内核也较大，系统移植需要至少512KB的RAM空间，1MB的ROM/FLASH空间。

#### 3.2 μC／OS-II

μC／OS-II是在μC/OS的基础上发展起来的，是用C语言编写的一个结构小巧、抢占式的多任务实时内核。μC／OS-II能管理64个任务，并提供任务调度与管理、内存管理、任务间同步与通信、时间管理和中断服务等功能，具有执行效率高、占用空间小、实时性能优良和扩展性强等特点。

在文件系统的支持方面，由于μC/OS-II是面向中小型嵌入式系统的，即使包含全部功能，编译后内核也不到10 KB。系统本身并没有提供对文件系统的支持。μC/OS-II具有良好的扩展性能，如果需要可以自行加入文件系统的内容。

在对硬件的支持上，μC/OS-II能够支持当前流行的大部分CPU，μC/OS-II由于本身内核就很小，经过裁剪后的代码最小可以为2KB，所需的最小数据RAM空间为4 KB，μC/OS-II的移植相对比较简单，只需要修改与处理器相关的代码就可以。

μC/OS-II是一个结构简单、功能完备和实时性很强的嵌入式操作系统内核，针对于没有MMU功能的CPU，它是非常合适的。它需要很少的内核代码空间和数据存储空间，拥有良好的实时性，良好的可扩展性能，并且是开源的。

#### 3.3 eCos

eCos(embedded Configurable operating system)，即嵌入式可配置操作系统。它是一个源代码开放的可配置、可移植、面向深度嵌入式应用的实时操作系统。最大特点是配置灵活，采用模块化设计，核心部分由小同的组件构成，包括内核、C语言库和底层运行包等。每个组件可提供大量的配置选项(实时内核也可作为可选配置)，使用eCos提供的配置工具可以很方便地配置，并通过不同的配置使得eCos能够满足不同的嵌入式应用要求。

eCos操作系统的可配置性非常强大，用户可以自己加入所需的文件系统。eCos操作系统同样支持当前流行的大部分嵌入式CPU，eCos操作系统可以在16位、32位和64位等不同体系结构之间移植。eCos由于本身内核就很小，经过裁剪后的代码最小可以为10 KB，所需的最小数据RAM空间为10 KB。

eCos最大特点是配置灵活，并且支持无MMU的CPU的移植，开源且具有很好的移植性。但eCOS的应用还不是太广泛，还没有像μC／OS-II那样普遍，并且资料也没有μC／OS-II多。

#### 3.4 FreeRTOS

由于RTOS需占用一定的系统资源(尤其是RAM资源)，只有μC／OS-II、embOS、salvo、FreeRTOS等少数实时操作系统能在小RAM单片机上运行。相对于C／OS-II、 embOS等商业操作系统，FreeRTOS操作系统是完全免费的操作系统，具有源码公开、可移植、可裁减、调度策略灵活的特点，可以方便地移植到各种单片机上运行。

作为一个轻量级的操作系统，FreeRTOS提供的功能包括：任务管理、时间管理、信号量、消息队列、内存管理、记录功能等，可基本满足较小系统的需要。

FreeRTOS内核支持优先级调度算法，每个任务可根据重要程度的不同被赋予一定的优先级，CPU总是让处于就绪态的、优先级最高的任务先运行。

FreeRT0S内核同时支持轮换调度算法，系统允许不同的任务使用相同的优先级，在没有更高优先级任务就绪的情况下，同一优先级的任务共享CPU的使用时间。

其不足之处， 一方面体现在系统的服务功能上，如FreeRTOS只提供了消息队列和信号量的实现，无法以后进先出的顺序向消息队列发送消息；另一方 面，FreeRTOS只是一个操作系统内核，需外扩第三方的GUI(图形用户界面)、TCP／IP协议栈、FS(文件系统)等才能实现一个较复杂的系统， 不像μC／OS-II可以和μC／GUI、μC／FS、μC／TCP-IP等无缝结合。

#### 3.5 RTX

ARM公司的一款嵌入式实时操作系统，使用标准的C结构编写，运用RealView编译器进行编译。不仅仅是一个实时内核，还具备丰富的中间层组件，不但免费，而且代码也是开放的。

主要功能：
* 开始和停止任务（进程），除此之外还支持进程通信，例如任务的同步、共享资源（外设或内存）的管理、任务之间消息的传递。
* 开发者可以使用基本函数去开启实时运行器，去开始和终结任务，以及去传递任务间的控制（轮转调度）。
* 开发者可以赋予任务优先级。

主要特点：
* 支持时间片，抢占式和合作式调度。
* 不限制数量的任务，每个任务都具有254的优先级。不限制数量的信号量，互斥信号量，消息邮箱和软定时器。
* 支持多线程和线程安全操作。
* 使用MDK基于对话框的配置向导，可以很方便的完成MDK的配置。

#### 3.6 VxWorks

美国WindRiver公司于1983年设计开发的一种嵌入式实时操作系（RTOS），具有硬实时、确定性与稳定性，也具备航空与国防、工业、医疗、汽车、消费电子产品、网络及其他行业要求的可伸缩性与安全性。

主要功能：
* 支持可预测的任务同步机制
* 支持多任务间的通信
* 存储器优化管理
* 操作系统的（中断延迟、任务切换、驱动程序延迟等）行为是可知的和可预测的。
* 实时时钟服务+中断管理服务。

主要特点：
* 具有一个高性能的操作系统内核Wind（实时性好、可裁减）
* 友好的开发调试环境、较好的兼容性
* 支持多种开发和运行环境

#### 3.7 QNX

诞生于1980年，是一种商用的遵从POSIX规范的类Unix嵌入式实时操作系统。

主要功能：
* 支持在同一台计算机上同时调度执行多个任务；
* 可以让多个用户共享一台计算机，这些用户可以通过多个终端向系统提交任务，与QNX进行交互操作。

主要特点：
* 核心仅提供4种服务：进程调度、进程间通信、底层网络通信和中断处理，其进程在独立的地址空间运行。
* 所有其它OS服务，都实现为协作的用户进程，因此QNX核心非常小巧（QNX4.x大约为12Kb）而且运行速度极快。

#### 3.8 都江堰操作系统（djyos）

都江堰操作系统，简称djyos，得名于一个伟大的水利工程：都江堰。

与传统操作系统不同，djyos不是以线程而是以事件为调度核心，这种调度算法使程序员摆脱模拟计算机执行过程编写程序的思维方式，而是按人类认知世界的方式编写应用程序，就如同在嵌入式编程中引入了VC似的。

djyos的调度算法使程序员可以摆脱线程和进程的束缚，djyos没有有关线程的api，一个完全不懂线程知识的程序员也可以顺利地在djyos下编写应用程序。

djyos 操作系统是以事件为核心进行调度的，这种调度策略使程序员可以按人类认知事物的习惯而不是计算机的习惯来编程。

#### 3.9 RT-Thread

RT-Thread是一个集实时操作系统（RTOS）内核、中间件组件和开发者社区于一体的技术平台，RT-Thread也是一个组件完整丰富、高度可伸缩、简易开发、超低功耗、高安全性的物联网操作系统。

RT-Thread具备一个IoT OS平台所需的所有关键组件，例如GUI、网络协议栈、安全传输、低功耗组件等等。

RT-Thread已经拥有一个国内最大的嵌入式开源社区，同时被广泛应用于能源、车载、医疗、消费电子等多个行业。

#### 3.10 SylixOS

SylixOS 是一个开源的跨平台的大型实时操作系统（RTOS），

行业涉及航空航天、军事防务、轨道交通、智能电网、工业自动化等诸多领域。SylixOS 完全符合 POSIX 规范，开源社区丰富的自由软件移植非常方便。

